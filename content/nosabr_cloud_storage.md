# Код-ревью проекта Cloud Storage API
- [GitHub](https://github.com/nosabr/cloud-storage-spring-boot)

## Соблюдение разделения на слои

### Controller слой
- **Плюсы**: Контроллеры используют сервисы для бизнес-логики, аннотации @Valid для валидации, логирование действий. http методы правильные.

### Service слой
- **Плюсы**: Сервисы содержат бизнес-логику, транзакции, валидацию. Разделение на FileNodeService, AuthService и т.д. Логирование действий.

### Repository слой
- **Плюсы**: Правильные индексы в БД.

### Domain слой (Entities)
- **Плюсы**: Правильные связи.
- Отдельно отмечу, что если используется управление схемой Бд через миграции, то аннотации hibernate можно убрать. Если в будущем индексы изменятся в миграции, то придется отражать это и в entity. Есть риск забыть это сделать и тогда будет рассинхрон кода и миграций

## Качество реализации REST

- **Эндпоинты и методы**:
  - POST /api/auth/sign-in — авторизация (200)
  - POST /api/auth/sign-up — регистрация (201)
  - GET /api/resources — все ресурсы (200)
  - GET /api/resources/{path} — ресурс по пути (200)
  - POST /api/resources/folders — создать папку (201)
  - POST /api/resources/{path} — загрузить файл (201)
  - GET /api/resources/{path}/download — скачать файл (200)
  - PUT /api/resources/{path} — переместить ресурс (200)
  - DELETE /api/resources/{path} — удалить ресурс (204)
- **Коды ответов**: Правильные 200, 201, 204, 400, 401, 403, 404, 409, 500. GlobalExceptionHandler маппит исключения корректно.
- **Формат**: JSON для ответов, multipart для загрузки файлов.

## Обработка ошибок и валидация

- **Обработка ошибок**: Кастомные исключения (ResourceNotFoundException и т.д.), GlobalExceptionHandler с логированием. Разные коды для разных типов ошибок.
- **Валидация**: @Valid в контроллерах, @NotBlank в DTO. Валидация путей и имен в сервисах.
- **Минусы**: Валидация в сервисах разбросана, нет централизованной валидации.

## Бизнес-логика

- **Плюсы**: Правильная иерархическая структура файлов/папок, обновление путей при перемещении. Валидация уникальности имен в папке.
- **Минусы**: Логика обновления путей в FileNodeService.updateAllChildren — рекурсивная, может быть неэффективной для глубоких деревьев. Нет лимита глубины.

## Корректность файлов для деплоя

- **Dockerfile**: Multi-stage build, правильное копирование jar, открытие порта. Можно облегчить образ, копируя только gradle/wrapper
- **application-docker.yaml**: Переопределяет datasource и storage для контейнеров.
- **docker-compose.yml**: пароли и прочие секреты стоит убрать в .env файл и использовать его для сборки

## Качество миграций данных, схемы БД, правильность индексов

- **Схема БД**: Правильные таблицы users и file_nodes. constraint для type.
- **Индексы**: idx_parent_id, idx_owner_id, idx_owner_parent, idx_path_owner — хорошие для запросов.
- **Миграции**: Liquibase с changesets, тестовые данные вставлены.
- **Минусы**: Нет индекса на name для поиска. updated_at не используется в логике?

## Реализация security

- **Плюсы**: Spring Security с сессиями в Redis, CORS настроен. Logout с удалением куки.

## Корректность и необходимость логирования

- **Плюсы**: @Slf4j в классах, логирование действий (info для успешных, warn для ошибок). Уровни в application.yaml настроены разумно.
- **Минусы**: Логирование в контроллерах — info для каждого запроса, может быть много. 

## Минусы ключевых классов

### FileNodeService
- deleteRecursively — рекурсия может вызвать StackOverflow для глубоких деревьев.

## Рекомендации по улучшению классов

FileNodeService: Заменить рекурсивный deleteRecursively на итеративный подход.
GlobalExceptionHandler: Добавить логирование деталей ошибок для debug.
Добавить README.md с инструкциями для запуска проекта локально.
Есть лишние комментарии и неиспользуемые методы.
Игнорирование подсказок IDE в некоторых местах. Можно поставить плагин SonarCube - помогает

## Заключение по архитектуре

### Что хорошо
- Хорошее разделение слоев, использование Spring Boot best practices.
- Правильная обработка ошибок и валидация.
- Корректная схема БД с индексами.
- Docker и конфигурация для деплоя.
- Качественные integration тесты с Testcontainers.

p.s. потрогать и поломать не удалось, к сожалению, т.к сервер недоступен
